{"version":3,"file":"Dynamic.js","sources":["Dynamic.js"],"names":["define","declare","lang","array","aspect","topic","query","domConst","domAttr","registry","_WidgetBase","_TemplatedMixin","_Contained","MenuItem","MenuSeparator","_Control","DynamicSublayer","DynamicFolder","legendUtil","i18n","DynamicControl","_layerType","_esriLayerType","_hasSublayers","_visLayersHandler","constructor","this","_sublayerControls","_layerTypePreInit","layer","layerInfos","length","controlOptions","sublayers","after","hitch","_layerTypeInit","isLegend","noLegend","controller","_expandClick","_createSublayers","dynamicSublayerLegend","expandNode","layerLegend","_expandRemove","_dynamicToggleMenuItems","menu","allSublayerToggles","addChild","label","dynamicSublayersOn","onClick","dynamicSublayersOff","_toggleAllSublayers","state","forEach","control","_setSublayerCheckbox","_setVisibleLayers","info","pid","parentLayerId","slids","subLayerIds","controlId","id","sublayerInfo","icons","place","domNode","byId","startup","push","_removeSublayerLegends","destroy","expandClickNode","remove","setLayers","i","get","parseInt","indexOf","sub","splice","setVisibleLayers","refresh","publish","visibleLayers","_onSetVisibleLayers","visLayers","visibleIds"],"mappings":"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","sourcesContent":["define([\n    'dojo/_base/declare',\n    'dojo/_base/lang',\n    'dojo/_base/array',\n    'dojo/aspect',\n    'dojo/topic',\n    'dojo/query',\n    'dojo/dom-construct',\n    'dojo/dom-attr',\n    'dijit/registry',\n    'dijit/_WidgetBase',\n    'dijit/_TemplatedMixin',\n    'dijit/_Contained',\n    'dijit/MenuItem',\n    'dijit/MenuSeparator',\n    './_Control', // layer control base class\n    './_DynamicSublayer',\n    './_DynamicFolder',\n    './../plugins/legendUtil',\n    'dojo/i18n!./../nls/resource'\n], function (\n    declare,\n    lang,\n    array,\n    aspect,\n    topic,\n    query,\n    domConst,\n    domAttr,\n    registry,\n    _WidgetBase,\n    _TemplatedMixin,\n    _Contained,\n    MenuItem,\n    MenuSeparator,\n    _Control, // most everything happens here\n    DynamicSublayer,\n    DynamicFolder,\n    legendUtil,\n    i18n\n) {\n    var DynamicControl = declare([_WidgetBase, _TemplatedMixin, _Contained, _Control], {\n        _layerType: 'overlay', // constant\n        _esriLayerType: 'dynamic', // constant\n        //_sublayerControls: [], // sublayer/folder controls\n        _hasSublayers: false, // true when sublayers created\n        _visLayersHandler: null,\n        constructor: function () {\n            this._sublayerControls = [];\n        },\n        _layerTypePreInit: function () {\n            if (this.layer.layerInfos.length > 1 && this.controlOptions.sublayers) {\n                // we have sublayer controls\n                this._hasSublayers = true;\n                this._visLayersHandler = aspect.after(this.layer, 'setVisibleLayers', lang.hitch(this, '_onSetVisibleLayers'), true);\n            }\n        },\n        // create sublayers and legend\n        _layerTypeInit: function () {\n            var isLegend = legendUtil.isLegend(this.controlOptions.noLegend, this.controller.noLegend);\n            if (isLegend && this.controlOptions.sublayers === true) {\n                this._expandClick();\n                this._createSublayers(this.layer);\n                aspect.after(this, '_createSublayers', lang.hitch(this, legendUtil.dynamicSublayerLegend(this.layer, this.expandNode)));\n            } else if (this.controlOptions.sublayers === false && isLegend) {\n                this._expandClick();\n                legendUtil.layerLegend(this.layer, this.expandNode);\n            } else if (this.controlOptions.sublayers === true && !isLegend) {\n                this._expandClick();\n                aspect.after(this, '_createSublayers', lang.hitch(this, '_removeSublayerLegends'));\n                this._createSublayers(this.layer);\n            } else {\n                this._expandRemove();\n            }\n        },\n        // called from LayerMenu plugin\n        _dynamicToggleMenuItems: function (menu) {\n            if (this._hasSublayers && this.controlOptions.allSublayerToggles !== false) {\n                menu.addChild(new MenuItem({\n                    label: i18n.dynamicSublayersOn,\n                    onClick: lang.hitch(this, '_toggleAllSublayers', true)\n                }));\n                menu.addChild(new MenuItem({\n                    label: i18n.dynamicSublayersOff,\n                    onClick: lang.hitch(this, '_toggleAllSublayers', false)\n                }));\n                menu.addChild(new MenuSeparator());\n            }\n        },\n        // toggle all sublayers on/off\n        _toggleAllSublayers: function (state) {\n            array.forEach(this._sublayerControls, function (control) {\n                control._setSublayerCheckbox(state);\n            });\n            this._setVisibleLayers();\n        },\n        // add folder/sublayer controls per layer.layerInfos\n        _createSublayers: function (layer) {\n            // check for single sublayer - if so no sublayer/folder controls\n            if (layer.layerInfos.length > 1) {\n                array.forEach(layer.layerInfos, lang.hitch(this, function (info) {\n                    var pid = info.parentLayerId,\n                        slids = info.subLayerIds,\n                        controlId = layer.id + '-' + info.id + '-sublayer-control',\n                        control;\n                    if (pid === -1 && slids === null) {\n                        // it's a top level sublayer\n                        control = new DynamicSublayer({\n                            id: controlId,\n                            control: this,\n                            sublayerInfo: info,\n                            icons: this.icons\n                        });\n                        domConst.place(control.domNode, this.expandNode, 'last');\n                    } else if (pid === -1 && slids !== null) {\n                        // it's a top level folder\n                        control = new DynamicFolder({\n                            id: controlId,\n                            control: this,\n                            sublayerInfo: info,\n                            icons: this.icons\n                        });\n                        domConst.place(control.domNode, this.expandNode, 'last');\n                    } else if (pid !== -1 && slids !== null) {\n                        // it's a nested folder\n                        control = new DynamicFolder({\n                            id: controlId,\n                            control: this,\n                            sublayerInfo: info,\n                            icons: this.icons\n                        });\n                        domConst.place(control.domNode, registry.byId(layer.id + '-' + info.parentLayerId + '-sublayer-control').expandNode, 'last');\n                    } else if (pid !== -1 && slids === null) {\n                        // it's a nested sublayer\n                        control = new DynamicSublayer({\n                            id: controlId,\n                            control: this,\n                            sublayerInfo: info,\n                            icons: this.icons\n                        });\n                        domConst.place(control.domNode, registry.byId(layer.id + '-' + info.parentLayerId + '-sublayer-control').expandNode, 'last');\n                    }\n                    control.startup();\n                    this._sublayerControls.push(control);\n                }));\n            }\n        },\n        // simply remove expandClickNode\n        _removeSublayerLegends: function () {\n            array.forEach(this._sublayerControls, function (control) {\n                if (!control.sublayerInfo.subLayerIds) {\n                    domConst.destroy(control.expandClickNode);\n                }\n            });\n        },\n        // set dynamic layer visible layers\n        _setVisibleLayers: function () {\n            // remove aspect handler\n            this._visLayersHandler.remove();\n            // because ags doesn't respect a layer group's visibility\n            //   i.e. layer 3 (the group) is not in array but it's sublayers are; sublayers will show\n            //   so check and if group is off also remove the sublayers\n            var layer = this.layer,\n                setLayers = [];\n            array.forEach(query('.' + layer.id + '-layerControlSublayerCheck'), function (i) {\n                if (domAttr.get(i, 'data-checked') === 'checked') {\n                    setLayers.push(parseInt(domAttr.get(i, 'data-sublayer-id'), 10));\n                }\n            });\n            array.forEach(layer.layerInfos, function (info) {\n                if (info.subLayerIds !== null && array.indexOf(setLayers, info.id) === -1) {\n                    array.forEach(info.subLayerIds, function (sub) {\n                        if (array.indexOf(setLayers, sub) !== -1) {\n                            setLayers.splice(array.indexOf(setLayers, sub), 1);\n                        }\n                    });\n                } else if (info.subLayerIds !== null && array.indexOf(setLayers, info.id) !== -1) {\n                    setLayers.splice(array.indexOf(setLayers, info.id), 1);\n                }\n            });\n            if (!setLayers.length) {\n                setLayers.push(-1);\n            }\n            layer.setVisibleLayers(setLayers);\n            layer.refresh();\n            topic.publish('layerControl/setVisibleLayers', {\n                id: layer.id,\n                visibleLayers: setLayers\n            });\n            // set aspect handler\n            this._visLayersHandler = aspect.after(this.layer, 'setVisibleLayers', lang.hitch(this, '_onSetVisibleLayers'), true);\n        },\n        _onSetVisibleLayers: function (visLayers) {\n            var visibleIds = [];\n            array.forEach(this.layer.layerInfos, function (info) {\n                if (array.indexOf(visLayers, info.id) !== -1) {\n                    visibleIds.push(info.id);\n                }\n                if (info.parentLayerId !== -1 && array.indexOf(visibleIds, info.parentLayerId) === -1) {\n                    visibleIds.push(info.parentLayerId);\n                }\n            });\n            array.forEach(this._sublayerControls, function (control) {\n                if (array.indexOf(visibleIds, control.sublayerInfo.id) !== -1) {\n                    control._setSublayerCheckbox(true);\n                } else {\n                    control._setSublayerCheckbox(false);\n                }\n            });\n        }\n    });\n    return DynamicControl;\n});"]}